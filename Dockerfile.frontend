# Dockerfile.frontend (Versi贸n de Depuraci贸n)

# Etapa 1: Construir la aplicaci贸n React/Vite
#FROM node:18-slim AS build
#WORKDIR /app

# 1. Copiar archivos de dependencias
#COPY package.json ./

# 2. Instalar dependencias
# Usa 'npm ci' si tienes package-lock.json para instalaciones m谩s estables
#RUN npm install 

# 3. Copiar todo el c贸digo fuente (incluye vite.config.js y src/)
#COPY . .

# 4. Compilar la aplicaci贸n
# Este paso DEBE generar la carpeta /app/dist
#RUN npm run build 

# ------------------------------------------------------------------
#  PASOS DE DEPURACIN (Busca el output de estos comandos)
# Muestra el contenido de la ra铆z /app
#RUN ls -la /app

# Muestra el contenido de la carpeta 'dist'. Si falla, el build fall贸.
#RUN ls -la /app/dist
# ------------------------------------------------------------------

# Etapa 2: Servir con Nginx
#FROM nginx:alpine
# Copiar la configuraci贸n de Nginx personalizada
#COPY nginx/default.conf /etc/nginx/conf.d/default.conf
# Copiar los archivos construidos desde la etapa anterior
#COPY --from=build /app/dist /usr/share/nginx/html/gestionIES 
#COPY --from=build /app/dist/ /usr/share/nginx/html/gestionIES/
# Exponer el puerto 80 (Nginx)
#EXPOSE 80
#CMD ["nginx", "-g", "daemon off;"]

### HACIA ARRIBA FUNCIONA

# Etapa 1: Build de React/Vite
FROM node:18-slim AS build
WORKDIR /app

# =========================
# Recibir build args y pasarlos a entorno
# =========================
ARG VITE_API_URL
ARG VITE_SERVER_URL
ARG VITE_APP_NAME
ARG VITE_IES_NAME
ARG VITE_DIRECCION_LINEA_1
ARG VITE_DIRECCION_LINEA_2
ARG VITE_DIRECCION_LINEA_3
ARG VITE_DIRECCION_LINEA_4
ARG VITE_DIRECCION_LINEA_5

ENV VITE_API_URL=$VITE_API_URL
ENV VITE_SERVER_URL=$VITE_SERVER_URL
ENV VITE_APP_NAME=$VITE_APP_NAME
ENV VITE_IES_NAME=$VITE_IES_NAME
ENV VITE_DIRECCION_LINEA_1=$VITE_DIRECCION_LINEA_1
ENV VITE_DIRECCION_LINEA_2=$VITE_DIRECCION_LINEA_2
ENV VITE_DIRECCION_LINEA_3=$VITE_DIRECCION_LINEA_3
ENV VITE_DIRECCION_LINEA_4=$VITE_DIRECCION_LINEA_4
ENV VITE_DIRECCION_LINEA_5=$VITE_DIRECCION_LINEA_5

# 1锔 Copiar dependencias
COPY package.json package-lock.json ./
RUN npm ci 

# 2锔 Limpiar posibles restos de builds anteriores y cache de Vite
RUN rm -rf dist node_modules/.vite

# 3锔 Copiar todo el c贸digo fuente
COPY . .

# 4锔 Build limpio de Vite/React
RUN npm run build

# 5锔 Opcional: listar archivos para depuraci贸n
RUN echo "=== /app/dist ===" && ls -la /app/dist

# Etapa 2: Servir con Nginx
FROM nginx:alpine

# Copiar configuraci贸n de Nginx
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

# Copiar build desde la etapa anterior
COPY --from=build /app/dist/ /usr/share/nginx/html/gestionIES/

# Exponer puerto
EXPOSE 80

# Comando de arranque
CMD ["nginx", "-g", "daemon off;"]
